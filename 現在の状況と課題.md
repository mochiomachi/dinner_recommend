# 夕食レコメンドBotの現在の状況と課題

## 🎯 プロジェクト概要
Cloudflare Workers上で動作するLINE Botで、OpenAI APIを活用した夕食レコメンド機能を提供。

## ✅ 完了している機能
- ✅ D1データベース接続・設定（`env.DB`問題解決済み）
- ✅ LINE Webhook設定・署名検証
- ✅ ユーザー登録・招待コード機能
- ✅ 食事記録機能（⭐評価、OpenAI解析）
- ✅ OpenAI API統合（GPT-4o-mini）
- ✅ 天気API連携（OpenWeatherMap）
- ✅ サンプルデータインポート（38件の過去食事履歴）
- ✅ レシピ生成機能（買い物リスト付き）
- ✅ 基本的なAI推薦機能

## 🔴 重大な課題
### 1. AIレコメンド機能のタイムアウト問題
**症状**: 「今日のおすすめは？」メッセージ後、30秒を超えても返答なし
**試行した対策**:
- 非同期処理化（即座にレスポンス → バックグラウンド処理）
- プロンプト軽量化（max_tokens: 400→200、temperature低下）
- データ取得範囲縮小（14日間に限定）

**根本原因の仮説**:
- Cloudflare Workers 30秒制限に引っかかっている
- OpenAI API呼び出しが予想以上に重い
- データベースクエリに時間がかかっている
- 何らかのメモリリークまたは無限ループ

### 2. デバッグ情報の不足
- Cloudflare Workersのリアルタイムログが見づらい
- どの処理でタイムアウトしているか特定困難

## 📝 技術仕様
- **プラットフォーム**: Cloudflare Workers (TypeScript)
- **データベース**: Cloudflare D1 (SQLite)
- **AI**: OpenAI GPT-4o-mini
- **外部API**: LINE Messaging API, OpenWeatherMap API
- **デプロイ**: `wrangler deploy --config wrangler.toml`

## 🗃️ データベース構造
```sql
-- users テーブル
id (TEXT PRIMARY KEY)
invited (INTEGER)
created_at (TEXT)

-- meals テーブル
id (INTEGER PRIMARY KEY AUTOINCREMENT)
user_id (TEXT)
ate_date (TEXT)
dish (TEXT)
tags (TEXT) -- JSON配列
rating (INTEGER)
mood (TEXT)
decided (INTEGER)
```

## 🎛️ 設定済み環境変数
- `OPENAI_API_KEY`: GPT-4o-mini用APIキー
- `LINE_CHANNEL_SECRET`: LINE署名検証用
- `LINE_CHANNEL_ACCESS_TOKEN`: LINEメッセージ送信用
- `OPENWEATHER_API_KEY`: 天気データ取得用

## 🚀 次のアクション候補
1. **詳細ログ追加**: タイムアウト原因特定のためログポイント増設
2. **段階的デバッグ**: レコメンド機能を分割して問題箇所を特定
3. **代替アーキテクチャ検討**: 
   - レコメンド処理を別のWorkerに分離
   - キューイングシステム導入
   - よりシンプルなレコメンドロジック
4. **パフォーマンス最適化**: データベースインデックス、クエリ最適化

## 📊 テストユーザー情報
- **UserID**: `U8908fdb52a3705527eed6b130b62fc0c`
- **招待コード**: `family2024`
- **サンプルデータ**: 2025年4-5月の38食分

## 🔧 開発コマンド
```bash
# ローカル開発
npm run dev

# デプロイ
npm run deploy

# データベース操作
wrangler d1 execute dinner-recommend-db --file=./sample-meals-import.sql --remote

# ログ確認
wrangler tail
```

---
**作成日**: 2025年6月6日  
**最終更新**: AI推薦タイムアウト問題調査中