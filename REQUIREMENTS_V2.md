# LINE Bot 夕食推薦システム 要件定義書 v2.0

## 基本コンセプト
**多様性を確保した夕食推薦で「前回と似た料理」問題を解決**

## 機能概要

### 1. 初回推薦機能
**対象メッセージ**: 「おすすめ」「レコメンド」「今日の夕食」等

**処理フロー**:
1. ユーザー情報取得（アレルギー・嫌い・好み）
2. 食事履歴分析（過去14日間）
3. 天気情報取得
4. バランス良い3品推薦
5. クイックリプライボタン表示

**推薦基準**:
- ユーザー設定反映（アレルギー・嫌い除外）
- 食事履歴からの好み学習
- 季節・天気に適した料理
- ジャンル・調理法の多様性

### 2. 再提案機能（エージェント）
**対象メッセージ**: 「他の提案」「違う料理」「あっさり」「がっつり」等

**処理フロー**:
1. 前回推薦セッション取得
2. 要求タイプ分析（diverse/light/hearty/different）
3. 回避戦略立案（前回と重複する要素特定）
4. 系統的多様性確保推薦
5. セッション履歴更新

**エージェント思考プロセス**:
```
分析 → 前回提案の主材料・ジャンル・調理法を特定
回避 → 重複要素を除外リスト化  
生成 → 完全に異なる軸での料理選択
```

### 3. レシピ機能
**対象メッセージ**: 「1」「2」「3」（番号選択）

**処理フロー**:
1. 最新セッションから選択料理特定
2. 詳細レシピ生成（材料・手順・調理時間）
3. 買い物リスト生成
4. 選択料理をDBに記録

## メッセージルーティング設計

```
ユーザーメッセージ
│
├── 🍽️ 初回推薦要求
│   ├── "おすすめ"/"レコメンド"/"今日の夕食"
│   └── → handleInitialRecommendation()
│
├── 🔄 再提案要求  
│   ├── "他の提案"/"違う料理"/"あっさり"/"がっつり"
│   └── → handleReRecommendation()
│
├── 📖 レシピ要求
│   ├── "1"/"2"/"3" 
│   └── → handleRecipeRequest()
│
├── ⭐ 食事記録
│   ├── "⭐3 ハンバーグ美味しかった"
│   └── → handleMealInput()
│
└── 💬 一般メッセージ
    └── → handleGeneralMessage()
```

## データベース設計

### 既存テーブル
- `users`: ユーザー情報（アレルギー・嫌い等）
- `meals`: 食事記録（評価・気分）

### エージェント用テーブル
- `recommendation_sessions`: 推薦セッション管理
- `recommended_dishes`: 推薦料理履歴（回避戦略用）

## プロンプト設計

### 1. 初回推薦プロンプト (`initial-recommendation.md`)
```
あなたは親しみやすい料理レコメンドAIです。
ユーザーの情報を基に、バランス良い3品を提案してください。

【ユーザー情報】
- アレルギー: {{allergies}}
- 嫌いな食材: {{dislikes}}  
- 最近の食事: {{recentMeals}}

【環境情報】
- 天気: {{weather}}
- 気温: {{temperature}}

【提案ルール】
1. 3品は異なるジャンル（和食・洋食・中華）
2. 調理時間30分以内
3. 季節・天気に適している
4. 魅力的な説明文付き

出力形式: 詳細な料理説明
```

### 2. 再提案プロンプト (`re-recommendation.md`)
```
エージェント思考で前回提案を分析し、完全に異なる料理を提案してください。

【前回提案分析】
{{previousRecommendations}}

【ユーザー要求】
- タイプ: {{requestType}}
- メッセージ: "{{originalMessage}}"

【回避戦略】
- 避ける食材: {{avoidIngredients}}
- 避けるジャンル: {{avoidGenres}}
- 避ける調理法: {{avoidCookingMethods}}

【エージェント思考プロセス】
1. 前回提案との差別化ポイント特定
2. ユーザー要求（あっさり/がっつり等）反映
3. 完全に異なる軸での料理選択

出力形式: JSON構造化データ
```

## クイックリプライUI

### 初回推薦後
- 「レシピ①」「レシピ②」「レシピ③」
- 「他の提案を見る」
- 「満足！」

### 再提案後
- 「レシピ①」「レシピ②」「レシピ③」  
- 「さっぱり系」「がっつり系」
- 「もう一度提案」
- 「満足！」

## 期待効果

### ユーザー体験
- ✅ 前回と似た料理の問題解決
- ✅ 自然な会話での再提案要求
- ✅ より精度の高い多様性確保
- ✅ 直感的なボタン操作

### 技術的メリット  
- ✅ 処理の明確化・効率化
- ✅ プロンプト管理の簡素化
- ✅ 保守性・拡張性の向上
- ✅ エラーハンドリング強化

## 成功指標

### 定量指標
- 再提案要求率: < 30%
- ユーザー満足度: > 80%
- レシピ選択率: > 60%
- エラー発生率: < 5%

### 定性指標
- 料理の多様性向上
- ユーザーの継続利用
- 自然な会話体験